---
layout: post
title: "Многоуровневая прокси-схема с использованием Xray"
---
Идея предполагает создание цепочки прокси-серверов, где один из них находится в вашей стране, а другой - за рубежом. Это вполне реализуемо, и подобная схема действительно может скрыть использование зарубежного прокси, так как для наблюдателя ваш трафик будет выглядеть как соединение с локальным сервером.

Когда речь идет о соединении между дата-центрами, особенно по магистральным каналам, скорость передачи данных обычно значительно выше, чем у обычного интернет-канала конечного пользователя. Поэтому в таком случае использование каскада прокси-серверов может оказаться даже быстрее, чем прямое подключение к удаленному прокси. Если основной целью является просто обход географических ограничений или увеличение скорости, и при этом передача данных не содержит ничего критичного, то шифрование может быть излишним. В этом случае можно обойтись стандартными настройками SOCKS-протокола без дополнительных мер защиты.
Для соединения между прокси-серверами будем использовать **Shadowsocks** - отличное решение для этой задачи благодаря своей производительности, простоте настройки и поддержке шифрования. Такая схема позволит создать быстрые и надежные прокси-соединения, обеспечив высокий уровень безопасности и анонимности.

## Введение

Многоуровневая прокси-схема позволяет использовать несколько прокси-серверов для скрытия маршрута и защиты данных, проходящих через интернет. В этой статье мы рассмотрим, как настроить такую схему с помощью **Xray** - это мощный и современный инструмент для создания прокси-серверов, который предлагает множество возможностей и гибкость в настройках. Он поддерживает различные протоколы, включая Shadowsocks, VMess, Trojan и многие другие. Использование **Xray-core** в качестве основы проекта - отличная идея, так как это позволит воспользоваться всеми преимуществами современных технологий и повысить безопасность соединений, а также при необходимости изменить протокол передачи данных между серверами не переустанавливая программное обеспечение, а только изменив файл настроек на обоих серверах.

## Зачем это нужно?

Предположим, вы хотите скрыть использование зарубежных сервисов и обойти сетевые блокировки. Для этого можно настроить два прокси-сервера:
1. **Локальный прокси** - будет принимать и отправлять запросы внутри вашей страны (например, к локальным сайтам и IP-адресам).
2. **Зарубежный прокси** - будет использоваться для доступа к интернет-ресурсам, находящимся за пределами вашей страны.

Эта схема скрывает реальные места подключения, так что ваше соединение будет казаться нормальным запросом на локальный сервер.

Необходимо арендовать два **VPS**, один в России, другой - за рубежом. Тематику выбора провайдеров затрагивать не будем.

## Шаги настройки
### 1. Установка Xray

Сначала установите **Xray** на ваши серверы, используя официальное руководство:

```bash
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)"
```

### 2. Настройка локального прокси

**Xray** поддерживает настройку правил маршрутизации трафика с помощью модуля `routing`. Вы можете настроить его так, чтобы локальный трафик (например, трафик к локальным IP-адресам или доменам) обрабатывался напрямую, а весь остальной трафик перенаправлялся через зарубежный прокси. В конфигурационном файле **Xray** на локальном сервере используем Shadowsocks для подключения к серверу за рубежом `/usr/local/etc/xray/config.json`:

```json
{
  "inbounds": [
    {
      "port": 1080,
      "protocol": "socks",
      "settings": {
        "udp": true
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom",
      "tag": "direct",
      "settings": {}
    },
    {
      "protocol": "shadowsocks",
      "tag": "proxy",
      "settings": {
        "servers": [
          {
            "address": "IP_заграничного_сервера",
            "port": 8388,
            "method": "aes-256-gcm",
            "password": "your_password"
          }
        ]
      }
    }
  ],
  "routing": {
    "domainStrategy": "IPIfNonMatch",
    "rules": [
      {
        "type": "field",
        "domain": [
          "geosite:category-ru",
          "domain:localhost"
        ],
        "outboundTag": "direct"
      },
      {
        "type": "field",
        "ip": [
          "geoip:private"
        ],
        "outboundTag": "direct"
      },
      {
        "type": "field",
        "ip": [
          "0.0.0.0/0"
        ],
        "outboundTag": "proxy"
      }
    ]
  }
}
```

Здесь мы настроили SOCKS-прокси на порту 1080, который будет использоваться вашим устройством для подключения. Подключение к локальному прокси осуществляется по протоколу **SOCKS**, не шифруется. Это обеспечивает прекрасную скорость работы.

### Анализ конфигурации

**1. Inbounds:**
```json
  "inbounds": [
    {
      "port": 1080,
      "protocol": "socks",
      "settings": {
        "udp": true
      }
    }
  ]
```

Входящее соединение настроено на порт 1080 с использованием протокола **SOCKS**. Также включена поддержка UDP-трафика.

**1.1 Inbounds: VLESS**

Если вас не утраивает открытый порт **SOCKS5** с доступом без имени и пароля, то можно использовать не менее быстрый транспорт **VLESS**, который лишь немного проиграет по скорости чистому **SOCKS5**, но даст вам аутентификацию клиента по **id**, секция `inbounds` будет выглядеть так:

```json
  "inbounds": [
    {
      "listen": "0.0.0.0",
      "port": 443,
      "protocol": "vless",
      "settings": {
        "clients": [
          {
            "id": "f569a24a-c5a2-43f5-bf67-0174fa7646b0"
          }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "none"
      }
    },
  ],
```
**id** можно сгенерировать на сервере или на клиенте командой: `xray uuid`

**1.2 Inbounds: XTLS-REALITY**

Если прям хочется зашифровать трафик (в чём я не вижу принципиальной необходимости, соединение с локальным сервером не вызовет подозрений, особенной если это один из отечественных облачных провайдеров), то используем **XTLS-REALITY**, которое создаст зашифрованное соединение. Если клиент опознан как "свой", сервер работает как прокси, а если нет - TLS подключение передается на какой-нибудь другой абсолютно реальный хост с TLS. Тут я рекомендую в качестве маскировочного сайта использовать сайт провайдера (обычно он расположен в той же подсети, где и арендованный вами локальный сервер). При этом секция `inbounds` будет выглядеть так:

```json
  "inbounds": [
    {
      "port": 443,
      "protocol": "vless",
      "settings": {
        "clients": [
          {
            "id": "your-uuid-here",
            "flow": "xtls-rprx-vision"
          }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "show": false,
          "target": "cloud.ru:443",
          "serverNames": ["cloud.ru"],
          "privateKey": "your-private-key",
          "shortIds": ["your-short-id"]
        }
      }
    }
  ],
```

Для настройки понадобится ряд параметров, это `id`, `privateKey`, `publicKey`. Часть из них нам может сгенерировать сам **XRay**:

```sh
root@vps:~# /usr/local/bin/xray uuid
55e2d01a-53f1-4ebe-8a67-eb36e57d5700

root@vps:~# /usr/local/bin/xray x25519
Private key: 6JQrpGi8Hgro0YCqiqRdN2ZK4snF82gA2kaMxgneKjM
Public key: lSpaRL7VvEpPzVwiLO4pJfxJQmIyMpnSXXDLorxtzx0

root@vps:~# openssl rand -hex 8
872e7b9a1b169d29
```

**2. Outbounds:**
```json
  "outbounds": [
    {
      "protocol": "freedom",
      "tag": "direct",
      "settings": {}
    },
    {
      "protocol": "shadowsocks",
      "tag": "proxy",
      "settings": {
        "servers": [
          {
            "address": "IP_заграничного_сервера",
            "port": 8388,
            "method": "aes-128-gcm",
            "password": "your_password"
          }
        ]
      }
    }
  ]
```

Здесь определены два исходящих маршрута:
   - "direct": прямой выход в интернет без использования прокси.
   - "proxy": маршрут через Shadowsocks на заграничный сервер с указанными параметрами (IP-адрес, порт, метод шифрования и пароль).

**3. Routing:**
```json  
"routing": {
  "domainStrategy": "IPIfNonMatch",
  "rules": [
    {
      "type": "field",
      "domain": [
        "geosite:category-ru",
        "domain:localhost"
      ],
      "outboundTag": "direct"
    },
    {
      "type": "field",
      "ip": [
        "geoip:private"
      ],
      "outboundTag": "direct"
    },
    {
      "type": "field",
      "ip": [
        "0.0.0.0/0"
      ],
      "outboundTag": "proxy"
    }
  ]
}
```

Правила маршрутизации определяют, каким маршрутом пойдет трафик:
   - Локальные российские сайты ("geosite:category-ru") и localhost идут напрямую ("direct").
   - Частные IP-адреса ("geoip:private") тоже идут напрямую.
   - Все остальные адреса ("0.0.0.0/0") отправляются через прокси ("proxy").

### 3. Настройка зарубежного прокси

Теперь настроим зарубежный прокси-сервер, который будет отправлять запросы в интернет, файл `/usr/local/etc/xray/config.json`:

```json
{
  "inbounds": [
    {
      "port": 8388,
      "protocol": "shadowsocks",
      "settings": {
        "method": "aes-256-gcm",
        "password": "your_password",
        "network": "tcp,udp"
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom",
      "settings": {}
    }
  ]
}
```

### 4. Обновление файлов `geoip.dat` и `geosite.dat` с помощью официального скрипта

Для точной маршрутизации трафика по географическим регионам Xray использует файлы `geoip.dat` и `geosite.dat`. Эти файлы содержат информацию о странах и доменах, и их необходимо регулярно обновлять. Это можно сделать с помощью официального скрипта **Xray**:

```bash
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install-geodata
```

### 5. Автоматизация обновлений

Если вы хотите, чтобы обновления файлов `geoip.dat` и `geosite.dat` происходили автоматически, можно настроить cron-задачу:

```bash
crontab -e
```

Добавьте строку для выполнения обновления раз в день (например, в 3:00 ночи):

```bash
0 3 * * * bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install-geodata && systemctl restart xray
```

Сохраните изменения и выйдите из редактора. Этот скрипт автоматически скачает актуальные версии файлов и обновит их, а также перезапустит **Xray**, чтобы новые настройки вступили в силу.
Использование официального скрипта **Xray** для установки и обновления геоданных - это самый простой и надежный способ поддерживать актуальность информации о географическом положении стран и доменов. Автоматизация этого процесса с помощью `cron` позволяет избежать рутинной работы и всегда иметь актуальные данные для маршрутизации трафика.

### Частые проблемы:
Ошибка **Xray-core** "Special user nobody configured, this is not safe!" связана с тем, что в файле службы systemd (xray.service) Xray-core настроен запускаться от имени системного пользователя nobody. Это не рекомендуется, так как пользователь nobody предназначен для минимальных прав доступа и часто используется другими службами, что может представлять угрозу безопасности. Для повышения безопасности лучше создать отдельного пользователя специально для **Xray-core**.

**Как исправить?**
1. Создайте нового системного пользователя для Xray-core, этот пользователь будет изолирован и иметь минимальные привилегии:
`useradd -r -d /var/lib/xray -s /usr/sbin/nologin xray`
  * -r: Создаёт системного пользователя без домашней директории.
  * -d /var/lib/xray: Указывает директорию для хранения файлов Xray (например, логов).
  * -s /usr/sbin/nologin: Запрещает этому пользователю входить в систему.

2. Измените владельца конфигурационных файлов, убедитесь, что пользователь xray имеет доступ к файлам Xray:
  `chown -R xray:xray /usr/local/etc/xray`
  `chown -R xray:xray /var/log/xray`

3. Отредактируйте файл службы Xray, откройте файл службы systemd:
  `nano /etc/systemd/system/xray.service`
  Найдите строку: `User=nobody`
  И замените её на: `User=xray`
  Сохраните изменения и закройте файл.

4. Перезагрузите systemd и **Xray**:
  Обновите конфигурацию systemd: `systemctl restart xray`
  Перезапустите Xray: `systemctl restart xray`
  Проверьте статус Xray: `systemctl status xray`

## Заключение

Теперь у вас настроена многоуровневая прокси-система, которая обеспечивает шифрование трафика и скрывает использование зарубежных сервисов. Локальный прокси принимает запросы, а зарубежный сервер отправляет их в интернет. Это решение подходит для обеспечения анонимности и обхода сетевых блокировок. В моём случае прекрасно работают ресурсы **Google Gemini**, **ChatGPT**, **Microsoft Copilot** и т.д.
